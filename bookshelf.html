<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- PC -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="description" content="">
    <!-- mobile -->
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0, shrink-to-fit=no">

    <title>Books Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa"
            crossorigin="anonymous"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="css/bookshelf.css">
    <style>

        header{
            height: 400px;
        }
        nav{
            height: 50px;
        }
        footer{
            min-height: 300px;
        }
        main {
            background-color: lightsteelblue;
            padding: 15px 15px;
        }
    </style>
</head>
<body>
<div class="container">
    <div id="liveAlertPlaceholder"></div>
    <header class="row"></header>
    <nav></nav>
    <main>
        <div class="main-top">
            <div class="input-group input-group-sm mb-0 justify-content-center">
                <button type="button" class="btn btn-primary btn-md" data-bs-toggle="modal"
                        data-bs-target="#staticBackdrop">ADD
                </button>
                <label class="input-group-text" for="inputSearchType">Mode</label>
                <select class="col-md-1" id="inputSearchType">
                    <option value="1">Fuzzy</option>
                    <option value="2">Exact</option>
                </select>
                <label class="input-group-text" for="inputColName">By</label>
                <select class="col-md-1" id="inputColName">
                    <option value="1">Book Title</option>
                    <option value="2">Author</option>
                    <option value="3">Publisher</option>
                    <option value="4">Language</option>
                    <option value="5">Category</option>
                </select>
                <input type="text" class="col-md-4"
                       id="inputSearchContent"
                       placeholder="Input content for searching"
                       aria-label="Recipient's username" aria-describedby="button-addon2">
                <button class="btn btn-outline-secondary btn-primary" style="color:white" type="button"
                        id="btnSearch">Search
                </button>
            </div>
        </div>
        <div id="cardsWrapper" class="portfolio">

        </div>
        <div class="main-bot">
            <nav id="pageWrapper" aria-label="Page navigation" style="height: 35px;">
                <ul class="pagination pagination-sm justify-content-center">
                    <li class="page-item">
                        <a id="btnFirstPage" class="page-link" href="#">First</a>
                    </li>
                    <li class="page-item">
                        <a id="btnPrevPage" class="page-link" href="#">Prev</a>
                    </li>
                    <li class="page-item">
                        <a id="btnNextPage" class="page-link" href="#">Next</a>
                    </li>
                    <li class="page-item">
                        <a id="btnLastPage" class="page-link" href="#">Last</a>
                    </li>
                    <li>
                        <div class="input-group input-group-sm">
                            <label class="input-group-text" for="selectPage">Go to</label>
                            <select id="selectPage">
                                <option value="1">1</option>
                                <option selected value="2">2</option>
                            </select>
                        </div>
                    </li>
                </ul>

            </nav>
        </div>
    </main>
    <footer></footer>

    <!-- Modal -->
    <div class=" modal fade modal-lg" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false"
         tabindex="-1"
         aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addBookCaption">ADD A NEW BOOK</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col"></div>
                        <div class="col-8">
                            <form id="bookForm" enctype="multipart/form-data">
                                <div class="form-group mb-3">
                                    <label for="inputBookTitle" class="col-form-label">Book Title</label>
                                    <input type="text" name="bookTitle" class="form-control formItem"
                                           id="inputBookTitle" required>
                                    <div id="inputBookTitleInvalidFeedback" class="invalid-feedback">
                                        Please input valid book title.
                                    </div>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="inputAuthor" class="col-form-label">Author</label>
                                    <input type="text" name="author" class="form-control formItem" id="inputAuthor"
                                           required>
                                    <div class="invalid-feedback">
                                        Please input valid author name.
                                    </div>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="inputPublisher" class="col-form-label">Publisher</label>
                                    <input type="text" name="publisher" class="form-control formItem"
                                           id="inputPublisher" required>
                                    <div class="invalid-feedback">
                                        Please input valid publisher.
                                    </div>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="col-form-label" for="inputLanguage">Language</label>
                                    <select name="language" class="form-select is-valid formItem" id="inputLanguage">
                                        <option value="1">English</option>
                                        <option value="2">French</option>
                                        <option value="3">German</option>
                                        <option value="4">Mandarin</option>
                                        <option value="5">Japanese</option>
                                        <option value="6">Russian</option>
                                        <option value="7">Other</option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="col-form-label" for="inputCategory">Category</label>
                                    <select name="category" class="is-valid form-select formItem" id="inputCategory">
                                        <option value="1">Fiction</option>
                                        <option value="2">Nonfiction</option>
                                        <option value="3">Reference</option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="inputImage" class="col-form-label">Book cover image</label>
                                    <input name="image" class="form-control formItem" type="file" id="inputImage">
                                    <div id="fileInputInvalidFeedback" class="invalid-feedback">
                                        Image size should be smaller than 1MB.
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="col"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="dummyBtn" class="btn btn-primary" type="button" disabled hidden>
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        submitting...
                    </button>
                    <button id="submitBtn" type="submit" class="btn btn-primary" form="bookForm">Submit</button>
                    <button id="closeBtn" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    const inputImage = document.getElementById("inputImage")
    const fileInputInvalidFeedback = document.getElementById("fileInputInvalidFeedback")
    const inputBookTitle = document.getElementById("inputBookTitle")
    const inputAuthor = document.getElementById("inputAuthor")
    const inputPublisher = document.getElementById("inputPublisher")
    const inputLanguage = document.getElementById("inputLanguage")
    const inputCategory = document.getElementById("inputCategory")
    const bookForm = document.getElementById("bookForm")
    const alertPlaceholder = document.getElementById('liveAlertPlaceholder')
    const closeBtn = document.getElementById('closeBtn')
    const btnSearch = document.getElementById("btnSearch")

    const imgType = new Set(["jpg", "jpeg", "png", "bmp", "webp", "svg", "gif"])

    const nameReg = /^[\w'\-,.][^0-9_!¡?÷?¿/\\+=@#$%ˆ&*(){}|~<>;:[\]]{0,29}$/
    const titleReg = /[\w\d _.,!"'\[\]/$]*/

    axios.defaults.withCredentials = true
    axios.interceptors.request.use(
        config => {
            if (localStorage.eleToken) {
                config.headers.Authorization = localStorage.eleToken
            }
            return config
        },
        error => {
            return Promise.reject(error)
        }
    )
    axios.interceptors.response.use(
        response => {
            return response
        },
        error => {
            const {status} = error.response
            if (status === 401) {
                localStorage.removeItem('eleToken')
                location.href = '/login.html'
            }
            return Promise.reject(error)
        }
    )
    // params {'type': all/exa/fuz, 'colName': columnName, 'value': value}


    const getBookDataByConditions = (pageNumber) => {

        const inputSearchType = document.getElementById("inputSearchType")
        const searchType = inputSearchType.options[inputSearchType.selectedIndex].text.trim().substring(0, 3).toLowerCase()
        const inputColName = document.getElementById("inputColName")
        const inputValue = inputColName.options[inputColName.selectedIndex].text.trim()
        let colName = ''
        switch (inputValue) {
            case 'Book Title':
                colName = 'book_title'
                break
            case 'Author':
                colName = 'author'
                break
            case 'Publisher':
                colName = 'publisher'
                break
            case 'Language':
                colName = 'language'
                break
            case 'Category':
                colName = 'category'
                break
            default:
                break
        }
        if (!colName || colName === '') {
            return
        }
        if (!searchType || searchType === '') {
            return
        }

        const searchContent = document.getElementById("inputSearchContent").value.trim()
        if (!searchContent || searchContent === '') {
            return
        }
        let params = new FormData()
        params.append('type', searchType)
        params.append('colName', colName)
        params.append('searchContent', searchContent)
        params.append('pageNumber', pageNumber)
        // console.log('searchType: ', searchType)
        // console.log('colName: ', colName)
        // console.log('searchContent: ', searchContent)
        getBookData(params)
    }
    btnSearch.addEventListener("click", () => {
        getBookDataByConditions(1)
    })

    const getAllBookData = (pageNumber) => {
        let params = new FormData()
        params.append('type', 'all')
        params.append('pageNumber', pageNumber)
        getBookData(params)
    }
    window.addEventListener('load', () => {
        getAllBookData(1)
    })


    const getBookData = (params) => {
        axios({
            url: './php/getbooksdata.php',
            method: 'POST',
            data: params
        }).then(
            response => {
                if (response.data.code === "0") {
                    // fillTable(response.data.data)
                    makeCards(response.data.data)
                    makePagination(response.data.page)
                } else {
                    alert(response.data.message, 'danger')
                }

            },
            error => {
                alert(error.message, 'danger')
            }
        )
    }
    const makePagination = (page) => {
        const pageWrapper = document.getElementById("pageWrapper")
        if (page) {
            const btnFirstPage = document.getElementById("btnFirstPage")
            const btnPrevPage = document.getElementById("btnPrevPage")
            const btnNextPage = document.getElementById("btnNextPage")
            const btnLastPage = document.getElementById("btnLastPage")
            const selectPage = document.getElementById("selectPage")
            const {curPage, total, totalPage, searchType} = page
            const prevPage = curPage === 1 ? 1 : curPage - 1;
            const nextPage = curPage === totalPage ? totalPage : curPage + 1;
            selectPage.innerHTML = ''
            for (let i = 1; i <= totalPage; i++) {
                let option = document.createElement('option')
                option.text = i + ''
                if (i === curPage) {
                    option.selected = true
                }
                selectPage.appendChild(option)
            }
            btnFirstPage.addEventListener('click', (e) => {
                e.preventDefault()
                e.stopPropagation()
                if (searchType === 'all') {
                    return getAllBookData(1)
                } else {
                    return getBookDataByConditions(1)
                }
            })
            btnPrevPage.addEventListener('click', (e) => {
                e.preventDefault()
                e.stopPropagation()
                if (searchType === 'all') {
                    return getAllBookData(prevPage)
                } else {
                    return getBookDataByConditions(prevPage)
                }
            })
            btnNextPage.addEventListener('click', (e) => {
                e.preventDefault()
                e.stopPropagation()
                if (searchType === 'all') {
                    return getAllBookData(nextPage)
                } else {
                    return getBookDataByConditions(nextPage)
                }
            })
            btnLastPage.addEventListener('click', (e) => {
                e.preventDefault()
                e.stopPropagation()
                if (searchType === 'all') {
                    return getAllBookData(totalPage)
                } else {
                    return getBookDataByConditions(totalPage)
                }
            })

            selectPage.addEventListener('change', () => {
                const gotoPage = selectPage.options[selectPage.selectedIndex].text.trim()
                if (searchType === 'all') {
                    return getAllBookData(gotoPage)
                } else {
                    return getBookDataByConditions(parseInt(gotoPage))
                }
            })
            pageWrapper.style.display = 'block'
        } else {
            pageWrapper.style.display = 'none'
        }


    }
    const makeCards = data => {
        const cardsWrapper = document.getElementById("cardsWrapper")
        cardsWrapper.innerHTML = ''
        if (data && data.length !== 0) {

            for (let i = 0; i < data.length; i++) {
                cardsWrapper.innerHTML += `
<figure class="">
        <img src="${data[i].image}" alt="Book Cover">
        <figcaption>Detail...</figcaption>
</figure>
`
            }
        } else {
            alert('No searching result from database!', 'success')
        }
    }
    // const fillTable = data => {
    //     if (data && data.length !== 0) {
    //         // console.log(data)
    //         displayTbody.innerHTML = ''
    //         for (let i = 0; i < data.length; i++) {
    //             displayTbody.innerHTML += `
    //                 <tr>
    //                 <td>${data[i].id}</td>
    //                 <td colspan="2" class="bookTitleTd" style="font-style: oblique">${data[i].book_title}</td>
    //                 <td colspan="2">${data[i].author}</td>
    //                 <td colspan="2">${data[i].publisher}</td>
    //                 <td>${data[i].language}</td>
    //                 <td>${data[i].category}</td>
    //                 <td>${data[i].status}</td>
    //                 <td><img src="${data[i].image}" alt="book cover image"></td>
    //                 <td>
    //                     <button type="button" class="btn btn-warning btn-sm"
    //                             style="--bs-btn-padding-x:1rem; color:white" onclick="handleEdit(${data[i].id})">edit
    //                     </button>
    //                     <button type="button" class="btn btn-danger btn-sm" onclick="handleDelete(${data[i].id})">delete
    //                     </button>
    //
    //                 </td>
    //             </tr>
    //             `
    //         }
    //     } else {
    //         alert('No searching result from database!', 'success')
    //     }
    // }
    const handleEdit = (id) => {
        console.log('edit' + id)
    }
    const handleDelete = (id) => {
        console.log('delete' + id)
    }

    bookForm.addEventListener("submit", (e) => {
        e.preventDefault()
        e.stopPropagation()
        const elements = document.getElementsByClassName("is-valid")
        if (elements.length === 6) {
            toggleInputsAndBtn('disabled')
            const bookTitle = inputBookTitle.value.trim()
            const author = inputAuthor.value.trim()
            const publisher = inputPublisher.value.trim()
            const language = inputLanguage.options[inputLanguage.selectedIndex].text.trim()
            const category = inputCategory.options[inputCategory.selectedIndex].text.trim()
            const image = inputImage.files[0]
            let param = new FormData()
            param.append('image', image, image.name)
            param.append('bookTitle', bookTitle)
            param.append('author', author)
            param.append('publisher', publisher)
            param.append('language', language)
            param.append('category', category)
            //todo session control
            param.append('memberId', '')
            let config = {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            }
            axios({
                url: './php/add.php',
                method: 'POST',
                data: param,
                config: config
            }).then(response => {
                if (response.data.code === '0') {
                    getAllBookData()
                    bookForm.reset()
                    toggleInputsAndBtn('able')
                    inputBookTitle.classList.remove('is-valid')
                    inputAuthor.classList.remove('is-valid')
                    inputPublisher.classList.remove('is-valid')
                    inputImage.classList.remove('is-valid')
                    alert('New book added successfully!', 'success')
                    closeBtn.click()
                } else {
                    toggleInputsAndBtn('able')
                    alert('Failed to add new book, ' + response.data.message, 'danger')
                }

            }).catch(error => {
                toggleInputsAndBtn("able")
                alert(error.message + "please try again later", "danger")
            })
        }
    })


    inputBookTitle.addEventListener("change", e => {
        checkField(e, titleReg, 100)
    })
    inputAuthor.addEventListener("change", e => {
        checkField(e, nameReg, 30)
    })
    inputPublisher.addEventListener("change", e => {
        checkField(e, nameReg, 30)
    })


    const checkField = (e, reg, len) => {
        const ele = e.target
        const v = ele.value.trim()
        if (v.length <= len && reg.test(v)) {
            changeInputStatus(ele, "is-valid")
            return true
        } else {
            changeInputStatus(ele, "is-invalid")
            return false
        }
    }

    const checkImgType = type => {
        if (imgType.has(type)) {
            return true
        } else {
            fileInputInvalidFeedback.innerHTML = "Please select a valid BOOK COVER IMAGE"
            return false
        }
    }
    const checkImgSize = size => {
        if (size < 1 || size > 1024 * 1024) {
            fileInputInvalidFeedback.innerHTML = "Image size should be smaller than 1MB."
            return false
        } else {
            return true
        }
    }
    inputImage.addEventListener("change", event => {
        if (event.target.files) {
            const type = event.target.files[0].type.split("/")[1]
            const size = event.target.files[0].size
            if (!checkImgType(type)) {
                changeInputStatus(inputImage, "is-invalid")
                return
            }
            if (!checkImgSize(size)) {
                changeInputStatus(inputImage, "is-invalid")
                return
            }
            changeInputStatus(inputImage, "is-valid")
        }

    })

    function changeInputStatus(ele, statu) {
        switch (statu) {
            case "is-valid":
                if (!ele.classList.contains("is-valid")) {
                    if (ele.classList.contains("is-invalid")) {
                        ele.classList.remove("is-invalid")
                    }
                    ele.classList.add("is-valid")
                }
                break;
            case "is-invalid":
                if (!ele.classList.contains("is-invalid")) {
                    if (ele.classList.contains("is-valid")) {
                        ele.classList.remove("is-valid")
                    }
                    ele.classList.add("is-invalid")
                }
                break;
            default:
                break;
        }
    }

    const toggleInputsAndBtn = (dest) => {
        const inputs = document.getElementsByClassName("formItem")
        const btn = document.getElementById("submitBtn")
        const dummyBtn = document.getElementById("dummyBtn")
        if (dest === "disabled") {
            for (let i = 0; i < inputs.length; i++) {
                inputs[i].setAttribute("disabled", "true")
            }
            btn.setAttribute("hidden", "true")
            dummyBtn.removeAttribute("hidden")
        } else {
            for (let i = 0; i < inputs.length; i++) {
                inputs[i].removeAttribute("disabled")
            }
            btn.removeAttribute("hidden")
            dummyBtn.setAttribute("hidden", "true")
        }
    }

    const alert = (message, type) => {
        const wrapper = document.createElement('div')
        wrapper.innerHTML = [
            `<div class="alert alert-${type} alert-dismissible" role="alert">`,
            `   <div>${message}</div>`,
            '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
            '</div>'
        ].join('')
        alertPlaceholder.append(wrapper)
    }


</script>

</body>
</html>
